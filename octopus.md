# 第二部分：八边形包围基元的数学推导
为了构建一个紧密贴合的八边形，我们首先需要精确描述高斯基元在2D图像空间的椭圆轮廓。本节的推导将严格遵循Speedy-Splat  中建立的数学框架，以确保一致性。

## 2.1 投影2D椭圆方程
每个3D高斯基元由其均值（位置）$\mu_i \in \mathbb{R}^3$、缩放因子$s_i \in \mathbb{R}^3$、旋转四元数$r_i \in \mathbb{R}^4$和不透明度$\sigma_i \in \mathbb{R}$共同定义$[1,5]$。渲染过程的第一步是将3D协方差矩阵$\Sigma_{i_{3D}}$通过视图变换矩阵$W$和透视投影的雅可比矩阵$J$投影到2D图像空间，得到2D协方差矩阵$\Sigma_{i_{2D}}$。

一个高斯基元对像素$p$的alpha贡献值$\alpha_i(p)$由下式给出：
$\alpha_i(p) = \sigma_i \cdot \exp\left(-\frac{1}{2}(p - \mu_{i_{2D}})^T \Sigma_{i_{2D}}^{-1} (p - \mu_{i_{2D}})\right)$
其中，$\mu_{i_{2D}}$是3D均值投影后的2D中心点 。

在3DGS的渲染管线中，alpha值低于阈值1/255的贡献被忽略。因此，我们可以通过设置$\alpha_i(p) = 1/255$来定义椭圆的边界。代入并整理上式，可得：
$(p - \mu_{i_{2D}})^T \Sigma_{i_{2D}}^{-1} (p - \mu_{i_{2D}}) = 2 \log(255\sigma_i)$
为了简化分析，我们进行中心化处理。令$p_d = p - \mu_{i_{2D}} = (x_d, y_d)^T$，并将2D协方差矩阵的逆记为$\Sigma_{i_{2D}}^{-1} = \begin{pmatrix} a & b \\ b & c \end{pmatrix}$。同时，定义一个与不透明度相关的常数$t = 2 \log(255\sigma_i)$。由此，我们得到了描述椭圆边界的中心二次型方程：
$ax_d^2 + 2bx_dy_d + cy_d^2 = t \quad (*)$
这个方程是后续所有顶点计算的数学基础 。

## 2.2 求解旋转椭圆的切点
一个紧密贴合的、轴对齐的八边形，其八个顶点对应于椭圆边界上切线斜率为$m \in \{0, \infty, 1, -1\}$的八个点。为了找到这些点，我们首先需要求解椭圆上任意点的切线斜率。

通过对二次型方程 ($\ast$) 关于$x_d$进行隐式微分，我们得到：

$2ax_d + 2b(\frac{dy_d}{dx_d}x_d + y_d) + 2cy_d\frac{dy_d}{dx_d} = 0$

整理后，得到斜率$m = \frac{dy_d}{dx_d}$的表达式：
$m = \frac{dy_d}{dx_d} = -\frac{ax_d + by_d}{bx_d + cy_d} \quad (**)$
这是一个针对一般二次曲线的标准结果 。

现在，我们可以分情况求解不同斜率下的切点坐标：

### 情况1：水平与垂直切点（$m = 0, \infty$）
当$m = 0$时，式$(**)$的分子为零，即$ax_d + by_d = 0$，得到$y_d = -\frac{a}{b}x_d$。将此关系代入椭圆方程$(*)$，可以解出两个对应的$(x_d, y_d)$坐标。这两个点定义了椭圆的最高点和最低点，即AABB的上下边界。

当$m = \infty$时，式$(**)$的分母为零，即$bx_d + cy_d = 0$，得到$y_d = -\frac{b}{c}x_d$。同样代入方程$(*)$求解，得到椭圆的最左点和最右点，即AABB的左右边界。

这四个点与Speedy-Splat中SnugBox算法计算出的AABB极值点完全一致 。它们构成了我们八边形的四个轴对齐顶点。

### 情况2：对角切点（$m = 1, -1$）
当$m = 1$时，式$(**)$等于1：
$-\frac{ax_d + by_d}{bx_d + cy_d} = 1 \implies ax_d + by_d = -bx_d - cy_d \implies (a + b)x_d + (b + c)y_d = 0$
这给出了$x_d$和$y_d$之间的一个线性关系。

当$m = -1$时，式$(**)$等于-1：
$-\frac{ax_d + by_d}{bx_d + cy_d} = -1 \implies ax_d + by_d = bx_d + cy_d \implies (a - b)x_d + (b - c)y_d = 0$
这给出了另一个线性关系。

对于$m = 1$和$m = -1$这两种情况，我们都可以将得到的线性关系（例如，解出$y_d = -\frac{a + b}{b + c}x_d$）代回到主椭圆方程$(*)$中。这将得到一个关于$x_d^2$的二次方程，解出$x_d$后即可求得对应的$y_d$。每种斜率下都能解出两个切点，这四个点共同构成了八边形的四个对角顶点。这种求解方法在数学上是稳健的，并且利用了二次曲线切线求解的标准方法 。

## 2.3 八边形顶点最终公式
通过上述推导，我们可以得到八边形八个顶点$(V_0, \ldots, V_7)$相对于椭圆中心$\mu_{i_{2D}}$的偏移量$(x_d, y_d)$的显式计算公式。这些公式将完全由2D协方差矩阵逆$\Sigma_{i_{2D}}^{-1}$的系数$a, b, c$以及由不透明度导出的项$t$来表示。最终的屏幕空间顶点坐标为$(x, y) = (\mu_{i_{2D}}.x + x_d, \mu_{i_{2D}}.y + y_d)$。

在推导过程中，一个关键的观察点是，求解这些顶点坐标不可避免地需要进行开方运算（sqrt），这源于求解二次方程。例如，在求解$m = 1$的切点时，最终会得到形如$K \cdot x_d^2 = t$的方程，其中$K$是$a, b, c$的组合。其解为$x_d = \pm \sqrt{\frac{t}{K}}$。

这引出了一个重要的实现细节和潜在的性能问题。项$t = 2 \log(255\sigma_i)$在$\sigma_i < 1/255$时为负。同时，项$K$的符号取决于协方差矩阵的系数。如果最终根号内的表达式（判别式）为负，则开方运算无实数解，意味着该高斯基元由于不透明度过低，其影响范围根本无法达到1/255的alpha阈值，因而是完全不可见的。

因此，在实际的顶点计算代码中，必须包含对判别式符号的检查。这个检查构成了一个条件分支（if语句）。在GPU上，特别是CUDA架构中，当一个线程束（warp）内的不同线程执行不同的代码路径时，就会发生线程束发散，导致性能下降。这一点将在第四部分的性能分析中进行深入探讨。



## **第三部分：算法设计与CUDA实现**



基于上述数学推导，我们设计一种名为“OctagonSplat”的剔除方案，并探讨其在CUDA中的高效实现策略。



### **3.1 "OctagonSplat"剔除核函数概览**



我们的目标是替换3DGS渲染管线中的`preprocess`和`duplicateWithKeys`核函数 ，以集成八边形剔除逻辑。整个流程可以分解为以下步骤：  



1. **顶点计算**：对于每个高斯基元，在每个视图下计算一次其在屏幕空间的八个八边形顶点$(V_0,..., V_7)$。
2. **瓦片相交测试**：对于每个高斯基元，确定其八边形包围盒与哪些16x16像素的瓦片相交。
3. **结果输出**：在`preprocess`阶段，输出相交瓦片的**数量**。在`duplicateWithKeys`阶段，输出相交瓦片的**ID列表**。



### **3.2 八边形-瓦片相交测试算法**



对八边形AABB内的每个像素进行暴力测试是不可行的。我们需要一种更高效、更适合GPU并行计算的方法。我们提出一种基于**并行边缘函数测试**的算法。

1. **粗略剔除 (Coarse Culling)**：首先，计算八边形八个顶点的轴对齐包围盒（AABB）。这个AABB提供了一个需要检查的瓦片的粗略范围（`min_tile_x`, `max_tile_x`, 等）。只有在此范围内的瓦片才需要进行下一步的精确测试。

2. **边缘函数 (Edge Functions)**：对于八边形的每条边（例如由顶点Vi和$V_{i+1}$定义的边），我们可以定义一个边缘函数$E_{i, i+1}(P)$ 。这个函数具有一个重要特性：其值的符号可以判断一个点  

   

   P位于该边的哪一侧。对于一个凸多边形（如我们的八边形），一个点P位于其内部的充要条件是，它位于所有八条边的“内侧”。

3. **瓦片级测试 (Tile-Level Test)**：

   - **快速拒绝 (Fast Rejection)**：如果一个瓦片的四个角点都位于八边形某一条边的“外侧”，那么这个瓦片不可能与八边形相交，可以被立即剔除。这是一个非常高效的拒绝测试。
   - **保守包含 (Conservative Inclusion)**：为了确保不错过任何一个有部分重叠的瓦片（即实现保守光栅化），我们需要一个更严格的包含测试。一个瓦片必须被包含，如果：
     - 瓦片的AABB与八边形的AABB重叠。
     - 并且，该瓦片没有通过上述的快速拒绝测试。
   - 一个更精确的保守测试是：检查瓦片的四个角点是否有任何一个位于八边形内部。如果存在，则该瓦片必须被包含。此外，还需要检测八边形的边是否与瓦片的边界相交。一个综合的、鲁棒的测试方法是，对瓦片AABB和八边形AABB重叠的瓦片，执行更详细的边缘函数测试。